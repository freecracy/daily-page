import{_ as s,c as n,o as a,a as l}from"./app.eff5f3e9.js";const F=JSON.parse('{"title":"2022年01月25日","description":"","frontmatter":{},"headers":[{"level":2,"title":"头条","slug":"头条","link":"#头条","children":[]},{"level":2,"title":"code","slug":"code","link":"#code","children":[]},{"level":2,"title":"每日一题","slug":"每日一题","link":"#每日一题","children":[]}],"relativePath":"2022年01月25日.md","lastUpdated":1643124218000}'),p={name:"2022年01月25日.md"},o=l(`<h1 id="_2022年01月25日" tabindex="-1">2022年01月25日 <a class="header-anchor" href="#_2022年01月25日" aria-hidden="true">#</a></h1><h2 id="头条" tabindex="-1">头条 <a class="header-anchor" href="#头条" aria-hidden="true">#</a></h2><p><a href="https://toutiao.io/k/6rzknxe" target="_blank" rel="noreferrer">10 款优雅的 Go 语言开发工具</a></p><p><a href="https://toutiao.io/k/kjzeych" target="_blank" rel="noreferrer">几张图搞定Spring Cloud Allibaba注册中心的架构原理</a></p><p><a href="https://toutiao.io/k/w3wrja5" target="_blank" rel="noreferrer">平安保险基于 SPI 机制的 RocketMQ 定制化应用</a></p><p><a href="https://toutiao.io/k/y0dtjke" target="_blank" rel="noreferrer">马斯克：载人飞船上天前，我曾跪地祈祷；中台的本质和设计之道；Go GC 调优｜码农周刊VIP会员专属邮件周报 Vol.078</a></p><p><a href="https://toutiao.io/k/4dc37rq" target="_blank" rel="noreferrer">腾讯云十亿级 Node.js 网关的架构设计与工程实践</a></p><p><a href="https://toutiao.io/k/dfahlpc" target="_blank" rel="noreferrer">前端该如何优雅地Mock数据</a></p><p><a href="https://toutiao.io/k/dnx4tha" target="_blank" rel="noreferrer">为什么SpringBoot jar包中的文件读取不到？</a></p><p><a href="https://toutiao.io/k/uljyrzy" target="_blank" rel="noreferrer">Streaming 101:批处理之外的流式世界第一部分</a></p><p><a href="https://toutiao.io/k/fib82nl" target="_blank" rel="noreferrer">JVM调优的几种场景（建议收藏）</a></p><p><a href="https://toutiao.io/k/g9bytug" target="_blank" rel="noreferrer">如何落地业务建模(4) 将模型实现为RESTful API</a></p><p><a href="https://toutiao.io/k/5rqz8x0" target="_blank" rel="noreferrer">《雷锤3》魔数你见过吗？这10行代码简直吊炸天!</a></p><p><a href="https://toutiao.io/k/rvyc15u" target="_blank" rel="noreferrer">在线进行分库分表中间件的平滑升级，正所谓艺高人胆大</a></p><p><a href="https://toutiao.io/k/9you17q" target="_blank" rel="noreferrer">SkyWalking 针对 gRPC 的负载均衡和自动扩容实践</a></p><p><a href="https://toutiao.io/k/zw4evb3" target="_blank" rel="noreferrer">基于Calcite的分布式多数据源查询</a></p><p><a href="https://toutiao.io/k/9szt6fr" target="_blank" rel="noreferrer">开发者的瑞士军刀「GitHub 热点速览」</a></p><p><a href="https://toutiao.io/k/f1t7jy9" target="_blank" rel="noreferrer">聊一聊如何用C#轻松完成一个SAGA分布式事务</a></p><p><a href="https://toutiao.io/k/zyuypw7" target="_blank" rel="noreferrer">OpenPPL CUDA 技术解析</a></p><p><a href="https://toutiao.io/k/m7jujv7" target="_blank" rel="noreferrer">CPT：刷爆少样本REC任务！清华刘知远团队提出跨模态预训练Prompt Tuning</a></p><p><a href="https://toutiao.io/k/lpnakbk" target="_blank" rel="noreferrer">[推荐] Redis 很屌，不懂使用规范就糟蹋了</a></p><p><a href="https://toutiao.io/k/4ndh1gd" target="_blank" rel="noreferrer">[推荐] 面渣逆袭：Java并发六十问，图文详解，快来看看你会多少道！</a></p><p><a href="https://toutiao.io/k/mgym1lv" target="_blank" rel="noreferrer">[推荐] 浅谈缓存最终一致性的解决方案</a></p><p><a href="https://toutiao.io/k/1wuwmui" target="_blank" rel="noreferrer">[推荐] 服务探活的五种方式</a></p><p><a href="https://toutiao.io/k/zavpca4" target="_blank" rel="noreferrer">[推荐] 3万字 | 34 图 | Netty | 内核角度看IO模型</a></p><p><a href="https://toutiao.io/k/4g58j8v" target="_blank" rel="noreferrer">[推荐] 从零开始搭建公司微服务授权架构技术栈（3种模式），这架构稳的一批...</a></p><p><a href="https://toutiao.io/k/p935kqr" target="_blank" rel="noreferrer">[推荐] 面试官问：设计高并发系统的时候，数据库层面该如何设计？</a></p><p><a href="https://toutiao.io/k/c7mn7hz" target="_blank" rel="noreferrer">[推荐] 从MVC到DDD的架构演进</a></p><p><a href="https://toutiao.io/k/0mfx2nd" target="_blank" rel="noreferrer">[推荐] JVM调优的几种场景（建议收藏）</a></p><p><a href="https://toutiao.io/k/abc8vou" target="_blank" rel="noreferrer">[推荐] 优雅整洁的 Java 代码命名技巧，风之极·净化</a></p><p><a href="https://toutiao.io/k/1dauixx" target="_blank" rel="noreferrer">[推荐] 据说看完这篇 JVM 要一小时</a></p><p><a href="https://toutiao.io/k/zzaz6vu" target="_blank" rel="noreferrer">[推荐] 关于代码质量退化的思考</a></p><h2 id="code" tabindex="-1">code <a class="header-anchor" href="#code" aria-hidden="true">#</a></h2><p><a href="https://leetcode-cn.com/problems/count-of-matches-in-tournament" target="_blank" rel="noreferrer">比赛中的配对次数</a></p><h2 id="每日一题" tabindex="-1">每日一题 <a class="header-anchor" href="#每日一题" aria-hidden="true">#</a></h2><div class="language-go line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">                  Go </span><span style="color:#F78C6C;">1.15</span><span style="color:#A6ACCD;"> 中 </span><span style="color:#89DDFF;">var</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">interface{}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> a 会有额外堆内存分配吗？</span></span>
<span class="line"><span style="color:#A6ACCD;">具体代码是：</span></span>
<span class="line"><span style="color:#89DDFF;">var</span><span style="color:#A6ACCD;"> a  </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 以下有额外内存分配吗？</span></span>
<span class="line"><span style="color:#89DDFF;">var</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">interface{}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> a</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                  </span></span>
<span class="line"><span style="color:#A6ACCD;">                    查看答案</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#A6ACCD;">                  答案解析：</span></span>
<span class="line"><span style="color:#A6ACCD;">                  在 Go 中，接口被实现为一对指针（请参阅 Russ Cox 的 Go 数据结构：接口）：指向有关类型信息的指针和指向值的指针。可以简单的表示为：</span></span>
<span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">iface</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    tab  </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">itab</span></span>
<span class="line"><span style="color:#A6ACCD;">    data unsafe</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Pointer</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">其中 tab 是指向类型信息的指针；data 是指向值的指针。因此，一般来说接口意味着必须在堆中动态分配该值。</span></span>
<span class="line"><span style="color:#A6ACCD;">然而，</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">Go </span><span style="color:#F78C6C;">1.15</span><span style="color:#A6ACCD;"> 发行说明</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">在 runtime 部分中提到了一个有趣的改进：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Converting a small integer value into an </span><span style="color:#89DDFF;">interface</span><span style="color:#A6ACCD;"> value no longer causes allocation</span><span style="color:#89DDFF;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">意思是说，将小整数转换为接口值不再需要进行内存分配。小整数是指 </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> 到 </span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;"> 之间的数。</span></span>
<span class="line"><span style="color:#A6ACCD;">我们实际简单测试一下。</span></span>
<span class="line"><span style="color:#A6ACCD;">创建一个包 smallint，在包中创建文件 smallint</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;">，加上如下代码：</span></span>
<span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">smallint</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Convert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">val </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]interface{}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">var</span><span style="color:#A6ACCD;"> slice </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">make</span><span style="color:#89DDFF;">([]interface{},</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        slice</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> val</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> slice</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">为了更好的看到效果，函数中进行了 </span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;"> 次 </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> 到 </span><span style="color:#89DDFF;">interface</span><span style="color:#A6ACCD;"> 的转换。写个基准测试 smallint_test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;">：</span></span>
<span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">smallint_test</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">testing</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">test/smallint</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BenchmarkConvert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">b </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">testing</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">B</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> b</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">N</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        result </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> smallint</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Convert</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">12</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> result</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">分别使用 Go1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;"> 和 Go1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">15</span><span style="color:#A6ACCD;"> 版本进行测试：</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> version</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> version go1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">14.7</span><span style="color:#A6ACCD;"> darwin</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">amd64</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> test </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">bench </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">benchmem </span><span style="color:#89DDFF;">./...</span></span>
<span class="line"><span style="color:#A6ACCD;">goos</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> darwin</span></span>
<span class="line"><span style="color:#A6ACCD;">goarch</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amd64</span></span>
<span class="line"><span style="color:#A6ACCD;">pkg</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">smallint</span></span>
<span class="line"><span style="color:#A6ACCD;">BenchmarkConvert</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">569830</span><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">1966</span><span style="color:#A6ACCD;"> ns</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op     </span><span style="color:#F78C6C;">2592</span><span style="color:#A6ACCD;"> B</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op      </span><span style="color:#F78C6C;">101</span><span style="color:#A6ACCD;"> allocs</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op</span></span>
<span class="line"><span style="color:#A6ACCD;">PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">ok   test</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">smallint 1.647s</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> version</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> version go1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">15</span><span style="color:#A6ACCD;"> darwin</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">amd64</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> test </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">bench </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">benchmem </span><span style="color:#89DDFF;">./...</span></span>
<span class="line"><span style="color:#A6ACCD;">goos</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> darwin</span></span>
<span class="line"><span style="color:#A6ACCD;">goarch</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amd64</span></span>
<span class="line"><span style="color:#A6ACCD;">pkg</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">smallint</span></span>
<span class="line"><span style="color:#A6ACCD;">BenchmarkConvert</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">1859451</span><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">655</span><span style="color:#A6ACCD;"> ns</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op     </span><span style="color:#F78C6C;">1792</span><span style="color:#A6ACCD;"> B</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op        </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> allocs</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op</span></span>
<span class="line"><span style="color:#A6ACCD;">PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">ok   test</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">smallint 2.178s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">接着讲 smallint_test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> 中调用 Convert 的参数由 </span><span style="color:#F78C6C;">12</span><span style="color:#A6ACCD;"> 改为 </span><span style="color:#F78C6C;">256</span><span style="color:#A6ACCD;">，再次使用 Go1</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">15</span><span style="color:#A6ACCD;"> 运行，结果如下：</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> test </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">bench </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">benchmem </span><span style="color:#89DDFF;">./...</span></span>
<span class="line"><span style="color:#A6ACCD;">goos</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> darwin</span></span>
<span class="line"><span style="color:#A6ACCD;">goarch</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> amd64</span></span>
<span class="line"><span style="color:#A6ACCD;">pkg</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">smallint</span></span>
<span class="line"><span style="color:#A6ACCD;">BenchmarkConvert</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">551546</span><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">2049</span><span style="color:#A6ACCD;"> ns</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op     </span><span style="color:#F78C6C;">2592</span><span style="color:#A6ACCD;"> B</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op      </span><span style="color:#F78C6C;">101</span><span style="color:#A6ACCD;"> allocs</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">op</span></span>
<span class="line"><span style="color:#A6ACCD;">PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">ok   test</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">smallint 1.502s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">证明了上面提到的优化点。</span></span>
<span class="line"><span style="color:#A6ACCD;">那么，你想过它大概怎么实现的吗？因为上文提到，Go 中接口的实现，使用一个指针字段指向接口值。现在竟然不再额外进行内存分配，说明做了什么特殊的事情。</span></span>
<span class="line"><span style="color:#A6ACCD;">其实答案非常简单。如果你对 Python、Java 等语言熟悉，应该知道大概如何实现的。Go 中如何做的，可以在 Go CL </span><span style="color:#F78C6C;">216401</span><span style="color:#A6ACCD;"> 中（合并到</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">此提交</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">中了，GitHub 上更易于阅读）找到。具体来说就是 Go 中定义了一个特殊的静态数组，该数组由 </span><span style="color:#F78C6C;">256</span><span style="color:#A6ACCD;"> 个整数组成（</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> 到 </span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">）。当必须分配内存以将整数存储在堆上，并将其转换为接口的一部分时，它首先检查是否它可以只返回指向数组中适当元素的指针。这种经常使用的值的静态分配，是一种很常见的优化手段。例如，Python 对小整数执行类似的操作，Java 也有常量池，进行类似的优化处理。</span></span>
<span class="line"><span style="color:#A6ACCD;">实际上，Go 以前有一个优化，如果你将 </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> 转换为接口值，它将返回一个指向特殊静态零值的指针。这次新的 </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;"> 优化替代了该值。</span></span>
<span class="line"><span style="color:#A6ACCD;">对具体实现细节感兴趣的，可以阅读下上文提到的提交。</span></span>
<span class="line"><span style="color:#A6ACCD;">答案解析来自：https</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//mp.weixin.qq.com/s/1r0nt8nA3foDRRrbRp4omg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div>`,36),e=[o];function r(t,c,C,D,y,A){return a(),n("div",null,e)}const b=s(p,[["render",r]]);export{F as __pageData,b as default};
