import{_ as s,c as n,o as a,a as l}from"./app.eff5f3e9.js";const i=JSON.parse('{"title":"2022年03月28日","description":"","frontmatter":{},"headers":[{"level":2,"title":"头条","slug":"头条","link":"#头条","children":[]},{"level":2,"title":"code","slug":"code","link":"#code","children":[]},{"level":2,"title":"每日一题","slug":"每日一题","link":"#每日一题","children":[]}],"relativePath":"2022年03月28日.md","lastUpdated":1648398004000}'),p={name:"2022年03月28日.md"},o=l(`<h1 id="_2022年03月28日" tabindex="-1">2022年03月28日 <a class="header-anchor" href="#_2022年03月28日" aria-hidden="true">#</a></h1><h2 id="头条" tabindex="-1">头条 <a class="header-anchor" href="#头条" aria-hidden="true">#</a></h2><p><a href="https://toutiao.io/k/193vnpj" target="_blank" rel="noreferrer">尤娜系统的第一次飞行中换引擎的架构垂直拆分改造</a></p><p><a href="https://toutiao.io/k/v4pmufa" target="_blank" rel="noreferrer">浏览器缓存库设计总结（localStorage/indexedDB）</a></p><p><a href="https://toutiao.io/k/bpv0bbr" target="_blank" rel="noreferrer">京东到家购物车日志优化实践</a></p><p><a href="https://toutiao.io/k/x8y21dy" target="_blank" rel="noreferrer">兼容 tmux，类似 rz / sz 的 trzsz ( trz / tsz ) 发布 1.0 正式版</a></p><p><a href="https://toutiao.io/k/dd4p1x3" target="_blank" rel="noreferrer">解决分布式事务，Seata真香！</a></p><p><a href="https://toutiao.io/k/3jfuqw9" target="_blank" rel="noreferrer">开源｜用Rust编写的，闪电般快速且功能强大的代码编辑器</a></p><p><a href="https://toutiao.io/k/8t641lz" target="_blank" rel="noreferrer">简单软件架构的一些好处</a></p><p><a href="https://toutiao.io/k/z4a09sm" target="_blank" rel="noreferrer">淘宝APP用户行为数据分析</a></p><p><a href="https://toutiao.io/k/nlbg6ux" target="_blank" rel="noreferrer">企业级云原生应用交付及管理系列 - Helm 基础 (一)</a></p><p><a href="https://toutiao.io/k/zgqdeze" target="_blank" rel="noreferrer">基于 KubeVela 的机器学习实践</a></p><p><a href="https://toutiao.io/k/do40ece" target="_blank" rel="noreferrer">Facebook 开源 Golang 实体框架 Ent</a></p><p><a href="https://toutiao.io/k/405ts7m" target="_blank" rel="noreferrer">[推荐] Go 高性能编程技法</a></p><p><a href="https://toutiao.io/k/02whm5c" target="_blank" rel="noreferrer">[推荐] 2万字 + 50 张图，细说 JVM 内存分布、内存对齐、压缩指针！</a></p><p><a href="https://toutiao.io/k/enmg99d" target="_blank" rel="noreferrer">[推荐] 架构师如何选型分布式业务网关</a></p><p><a href="https://toutiao.io/k/yvw61mc" target="_blank" rel="noreferrer">[推荐] 如果你是一个Golang面试官，你会问哪些问题？</a></p><p><a href="https://toutiao.io/k/qnfl3t6" target="_blank" rel="noreferrer">[推荐] 最常用的架构模式</a></p><p><a href="https://toutiao.io/k/8jfl3pp" target="_blank" rel="noreferrer">[推荐] 消息队列经典十连问，你能扛到第几问？</a></p><p><a href="https://toutiao.io/k/qudsbeg" target="_blank" rel="noreferrer">[推荐] 你管这破玩意儿叫高可用</a></p><h2 id="code" tabindex="-1">code <a class="header-anchor" href="#code" aria-hidden="true">#</a></h2><p><a href="https://leetcode-cn.com/problems/binary-number-with-alternating-bits" target="_blank" rel="noreferrer">交替位二进制数</a></p><h2 id="每日一题" tabindex="-1">每日一题 <a class="header-anchor" href="#每日一题" aria-hidden="true">#</a></h2><div class="language-go line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">                  通常，JS 面试，闭包应该是必考的题目。随着越来越多的语言对函数式范式的支持，闭包问题经常出现。在 Go 语言中也是如此。</span></span>
<span class="line"><span style="color:#A6ACCD;">这是 Go 语言爱好者周刊第 </span><span style="color:#F78C6C;">90</span><span style="color:#A6ACCD;"> 期的一道题目。以下代码输出什么？</span></span>
<span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">fmt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	t </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hi</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">	c </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">b </span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		t </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> b</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> t</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> c</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	a </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	b </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">go</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">b</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">All</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">A：Hi All；B：Hi </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> All；C：Hi；D：</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> All</span></span>
<span class="line"><span style="color:#A6ACCD;">这道题目答对的人蛮多的：</span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">。不管你是答对还是答错，如果最后再加一行代码：fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">a</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">All</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;">，它输出什么？想看看你是不是蒙对了。（提示：你可以输出 t 的地址，看看是什么情况。）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                  </span></span>
<span class="line"><span style="color:#A6ACCD;">                    查看答案</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"><span style="color:#A6ACCD;">                  答案解析：</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F78C6C;">01</span><span style="color:#A6ACCD;"> 什么是闭包</span></span>
<span class="line"><span style="color:#A6ACCD;">维基百科对闭包的定义：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">在计算机科学中，闭包（英语：Closure），又称词法闭包（Lexical Closure）或函数闭包（function closures），是在支持头等函数的编程语言中实现词法绑定的一种技术。闭包在实现上是一个结构体，它存储了一个函数（通常是其入口地址）和一个关联的环境（相当于一个符号查找表）。环境里是若干对符号和值的对应关系，它既要包括约束变量（该函数内部绑定的符号），也要包括自由变量（在函数外部定义但在函数内被引用），有些函数也可能没有自由变量。闭包跟函数最大的不同在于，当捕捉闭包的时候，它的自由变量会在捕捉时被确定，这样即便脱离了捕捉时的上下文，它也能照常运行。捕捉时对于值的处理可以是值拷贝，也可以是名称引用，这通常由语言设计者决定，也可能由用户自行指定（如 C</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">）。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">关于（函数）闭包，有几个关键点：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">函数是一等公民；</span></span>
<span class="line"><span style="color:#A6ACCD;">闭包所处环境，可以引用环境里的值；</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">问到什么是闭包时，网上一般这么回答的：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">在支持函数是一等公民的语言中，一个函数的返回值是另一个函数，被返回的函数可以访问父函数内的变量，当这个被返回的函数在外部执行时，就产生了闭包。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">所以，上面题目中，函数 app 的返回值是另一个函数，因此产生了闭包。</span></span>
<span class="line"><span style="color:#F78C6C;">02</span><span style="color:#A6ACCD;"> Go 中的闭包</span></span>
<span class="line"><span style="color:#A6ACCD;">Go 中的函数是一等公民，之前写过一篇文章：函数是一等公民，这到底在说什么？</span></span>
<span class="line"><span style="color:#A6ACCD;">日常开发中，闭包是很常见的。举几个例子。</span></span>
<span class="line"><span style="color:#A6ACCD;">标准库</span></span>
<span class="line"><span style="color:#A6ACCD;">在 net</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">http 包中的函数 ProxyURL，实现如下：</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ProxyURL returns a proxy function (for use in a Transport)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// that always returns the same URL.</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ProxyURL</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fixedURL </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">URL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(*</span><span style="color:#A6ACCD;">Request</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">URL</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(*</span><span style="color:#A6ACCD;">Request</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">URL</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> fixedURL</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">它的返回值是另一个函数，签名是：</span></span>
<span class="line"><span style="color:#89DDFF;">func(*</span><span style="color:#A6ACCD;">Request</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">URL</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">在返回的函数中，引用了父函数（ProxyURL）的参数 fixedURL，因此这是闭包。</span></span>
<span class="line"><span style="color:#A6ACCD;">Web 中间件</span></span>
<span class="line"><span style="color:#A6ACCD;">在 Web 开发中，中间件一般都会使用闭包。比如 Echo 框架中的一个中间件：</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// BasicAuthWithConfig returns an BasicAuth middleware with config.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// See \`BasicAuth()\`.</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BasicAuthWithConfig</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">config BasicAuthConfig</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> echo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MiddlewareFunc </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">// Defaults</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Validator </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">panic</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">echo: basic-auth middleware requires a validator function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">next echo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">HandlerFunc</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> echo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">HandlerFunc </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">c echo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Context</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#676E95;font-style:italic;">/// 省略很多代码</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">首先，echo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MiddlewareFunc 是一个函数：</span></span>
<span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MiddlewareFunc</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">HandlerFunc</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> HandlerFunc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">而 echo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">HandlerFunc 也是一个函数：</span></span>
<span class="line"><span style="color:#89DDFF;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">HandlerFunc</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">Context</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">所以，上面的函数嵌套了几层，是典型的闭包。</span></span>
<span class="line"><span style="color:#A6ACCD;">这是闭包吗？</span></span>
<span class="line"><span style="color:#A6ACCD;">在 Go 中不支持函数嵌套定义，函数内嵌套函数，必须通过匿名函数的形式。匿名函数在 Go 中是很常见的，比如开启一个 goroutine，通常通过匿名函数。</span></span>
<span class="line"><span style="color:#A6ACCD;">现在有一个问题，以下代码是闭包吗？</span></span>
<span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">fmt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    a </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">func()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a =</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">如果按照上面网上一般的回答，这不是闭包，因为并没有返回函数。但按照维基百科的定义，这个属于闭包。有没有其他证据呢？</span></span>
<span class="line"><span style="color:#A6ACCD;">在 Go 语言规范中，关于函数字面值（匿名函数）有这么一句话：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Function literals are closures</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> they may refer to variables defined in a surrounding function</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> Those variables are then shared between the surrounding function and the function literal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> and they survive as long as they are accessible</span><span style="color:#89DDFF;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">也就是说，函数字面值（匿名函数）是闭包，它们可以引用外层函数定义的变量。</span></span>
<span class="line"><span style="color:#A6ACCD;">此外，在官方 FAQ 中有这样的说明：</span></span>
<span class="line"><span style="color:#A6ACCD;">What happens with closures running as goroutines?</span></span>
<span class="line"><span style="color:#A6ACCD;">例子是：</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    done </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">make</span><span style="color:#89DDFF;">(chan</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bool</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    values </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">b</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">c</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> v </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">range</span><span style="color:#A6ACCD;"> values </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">func()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">v</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            done </span><span style="color:#89DDFF;">&lt;-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// wait for all goroutines to complete before exiting</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">range</span><span style="color:#A6ACCD;"> values </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&lt;-</span><span style="color:#A6ACCD;">done</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">这是 Go 中很常见的代码（很容易写错的），FAQ 称开启 goroutine 的那个匿名函数是一个闭包。</span></span>
<span class="line"><span style="color:#F78C6C;">03</span><span style="color:#A6ACCD;"> 汇编看看实现</span></span>
<span class="line"><span style="color:#A6ACCD;">回到开始的题目，我们通过汇编看看，Go 闭包的实现，是不是按照维基百科说的，「闭包在实现上是一个结构体，它存储了一个函数（通常是其入口地址）和一个关联的环境（相当于一个符号查找表）」。</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> tool compile </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">S main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">看关键代码：</span></span>
<span class="line"><span style="color:#F78C6C;">0x0000</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	TEXT	</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> ABIInternal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">24</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">8</span></span>
<span class="line"><span style="color:#F78C6C;">0x0000</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TLS</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#F78C6C;">0x0009</span><span style="color:#A6ACCD;"> 00009 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	CMPQ	SP</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x000d</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00013</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#F78C6C;">0x000d</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00013</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	JLS	</span><span style="color:#F78C6C;">96</span></span>
<span class="line"><span style="color:#F78C6C;">0x000f</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00015</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#F78C6C;">0x000f</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00015</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	SUBQ	$</span><span style="color:#F78C6C;">24</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> SP</span></span>
<span class="line"><span style="color:#F78C6C;">0x0013</span><span style="color:#A6ACCD;"> 00019 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	BP</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x0018</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00024</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> BP</span></span>
<span class="line"><span style="color:#F78C6C;">0x001d</span><span style="color:#A6ACCD;"> 00029 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	FUNCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> gclocals·2a5305abe05176240e61b8620e19a815</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x001d</span><span style="color:#A6ACCD;"> 00029 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	FUNCDATA	$</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> gclocals·33cdeccccebe80329f1fdbee7f5874cb</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x001d</span><span style="color:#A6ACCD;"> 00029 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	type</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">noalg</span><span style="color:#89DDFF;">.struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> F </span><span style="color:#C792EA;">uintptr</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX</span></span>
<span class="line"><span style="color:#F78C6C;">0x0024</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00036</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x0028</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00040</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F78C6C;">0x0028</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00040</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	CALL	runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newobject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x002d</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00045</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX</span></span>
<span class="line"><span style="color:#F78C6C;">0x0032</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00050</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">func1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#F78C6C;">0x0039</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00057</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x003c</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00060</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	$</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x0044</span><span style="color:#A6ACCD;"> 00068 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">string</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hi</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#F78C6C;">0x004b</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00075</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x004f</span><span style="color:#A6ACCD;"> 00079 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">~r0</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">32</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F78C6C;">0x0054</span><span style="color:#A6ACCD;"> 00084 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> BP</span></span>
<span class="line"><span style="color:#F78C6C;">0x0059</span><span style="color:#A6ACCD;"> 00089 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	ADDQ	$</span><span style="color:#F78C6C;">24</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> SP</span></span>
<span class="line"><span style="color:#F78C6C;">0x005d</span><span style="color:#A6ACCD;"> 00093 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	RET</span></span>
<span class="line"><span style="color:#F78C6C;">0x005e</span><span style="color:#A6ACCD;"> 00094 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	NOP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">其中 LEAQ	type</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">noalg</span><span style="color:#89DDFF;">.struct</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> F </span><span style="color:#C792EA;">uintptr</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX 这行表明 Go 对闭包的实现和维基百科说的类似。</span></span>
<span class="line"><span style="color:#A6ACCD;">现在看看下面这种是不是这么实现的：</span></span>
<span class="line"><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">fmt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    a </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">func()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        fmt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a =</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">看看汇编</span></span>
<span class="line"><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#A6ACCD;"> tool compile </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">S test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span></span>
<span class="line"><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">func1 STEXT size</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">215</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0x8</span><span style="color:#A6ACCD;"> locals</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0x50</span><span style="color:#A6ACCD;"> funcid</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0x0</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0000</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	TEXT	</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">main</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">func1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> ABIInternal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">8</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0000</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TLS</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0009</span><span style="color:#A6ACCD;"> 00009 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	CMPQ	SP</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x000d</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00013</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x000d</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00013</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	JLS	</span><span style="color:#F78C6C;">205</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0013</span><span style="color:#A6ACCD;"> 00019 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0013</span><span style="color:#A6ACCD;"> 00019 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	SUBQ	$</span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> SP</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0017</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00023</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	BP</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 72</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x001c</span><span style="color:#A6ACCD;"> 00028 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	72</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> BP</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0021</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00033</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	FUNCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> gclocals·69c1753bd5f81501d95132d08af04464</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0021</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00033</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	FUNCDATA	$</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> gclocals·9fb7f0986f647f17cb53dda1484e0f7a</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0021</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00033</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">88</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0026</span><span style="color:#A6ACCD;"> 00038 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x002a</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00042</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x002a</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00042</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	CALL	runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convT64</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x002f</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00047</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0034</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00052</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">..</span><span style="color:#A6ACCD;">autotmp_21</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">64</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0039</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00057</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	type</span><span style="color:#89DDFF;">.[</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">]interface</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0040</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00064</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0044</span><span style="color:#A6ACCD;"> 00068 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0044</span><span style="color:#A6ACCD;"> 00068 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	CALL	runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newobject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0049</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00073</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x004e</span><span style="color:#A6ACCD;"> 00078 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	type</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">string</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0055</span><span style="color:#A6ACCD;"> 00085 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0058</span><span style="color:#A6ACCD;"> 00088 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">..</span><span style="color:#82AAFF;">stmp_1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x005f</span><span style="color:#A6ACCD;"> 00095 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0063</span><span style="color:#A6ACCD;"> 00099 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	LEAQ	type</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">int</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x006a</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00106</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x006e</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00110</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x006e</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00110</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	CMPL	runtime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeBarrier</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0075</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00117</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	JNE	</span><span style="color:#F78C6C;">189</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0077</span><span style="color:#A6ACCD;"> 00119 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">..</span><span style="color:#A6ACCD;">autotmp_21</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">64</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> CX</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x007c</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">00124</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	MOVQ	CX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 24</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">AX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0080</span><span style="color:#A6ACCD;"> 00128 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0x0080</span><span style="color:#A6ACCD;"> 00128 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;font-style:italic;">go</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	PCDATA	$</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">发现并没有这样的结构体，可见 Go 对这种情况做了特殊处理，因为它不是重复使用的匿名函数。</span></span>
<span class="line"><span style="color:#F78C6C;">04</span><span style="color:#A6ACCD;"> 总结</span></span>
<span class="line"><span style="color:#A6ACCD;">通过以上的讲解，对闭包应该有了更清晰的认识。如果面试中再被问到闭包，你可以这么回答：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">对闭包来说，函数在该语言中得是一等公民。一般来说，一个函数返回另外一个函数，这个被返回的函数可以引用外层函数的局部变量，这形成了一个闭包。通常，闭包通过一个结构体来实现，它存储一个函数和一个关联的上下文环境。但 Go 语言中，匿名函数就是一个闭包，它可以直接引用外部函数的局部变量，因为 Go 规范和 FAQ 都这么说了。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">面试官会不会被你惊到：原来如此，后一种说法我之前没有注意过。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> 月 </span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;"> 日更新：</span></span>
<span class="line"><span style="color:#A6ACCD;">来自微信公众号的读者 </span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">gopher </span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">留言：</span></span>
<span class="line"><span style="color:#A6ACCD;">noalg 代表不会生成 equal 和 hash 函数，因为闭包的 </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> 是匿名的，不存在比较或者作为 key 的场景。</span></span>
<span class="line"><span style="color:#A6ACCD;">F </span><span style="color:#C792EA;">uintptr</span><span style="color:#A6ACCD;"> 更准确的说应该是 </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">F </span><span style="color:#C792EA;">uintptr</span><span style="color:#A6ACCD;">，编译器生成的符号大部分都是</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">开头的。</span></span>
<span class="line"><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> 表示捕获了一个 </span><span style="color:#C792EA;">string</span><span style="color:#A6ACCD;"> 类型的变量 t，而且是 by value 而不是 by reference，因为</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">We use value capturing for values &lt;= 128 bytes that are never reassigned after capturing (effectively constant).</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">。</span></span>
<span class="line"><span style="color:#A6ACCD;">通过 </span><span style="color:#89DDFF;">(func)(*struct)</span><span style="color:#A6ACCD;"> 的类型转换，即可通过 </span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">F 找到对应的函数。</span></span>
<span class="line"><span style="color:#A6ACCD;">题外话：closure 通过 </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> 实现只是为了 GC 更友好，另外匿名 </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> 是为了不同的 </span><span style="color:#89DDFF;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">共用</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">struct</span><span style="color:#A6ACCD;"> 的可能性。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">答案解析来自：https</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//polarisxu.studygolang.com/posts/go/action/go-closure/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br></div></div>`,24),e=[o];function t(r,c,D,C,y,F){return a(),n("div",null,e)}const b=s(p,[["render",t]]);export{i as __pageData,b as default};
